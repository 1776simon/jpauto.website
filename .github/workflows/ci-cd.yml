name: CI/CD Pipeline

# This workflow builds the Jekyll site, validates HTML, checks links,
# deploys to GitHub Pages, purges Cloudflare cache, and runs Lighthouse audits

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master
  schedule:
    # Run link checker weekly on Mondays at 9am UTC
    - cron: '0 9 * * 1'

jobs:
  # Build Jekyll site - runs on all triggers
  build:
    name: Build Jekyll Site
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.4'
          bundler-cache: true # runs 'bundle install' and caches gems

      - name: Build Jekyll site
        run: bundle exec jekyll build
        env:
          JEKYLL_ENV: production

      - name: Upload built site
        uses: actions/upload-artifact@v4
        with:
          name: jekyll-site
          path: _site/
          retention-days: 1

  # Validation job - runs on all triggers
  validate:
    name: Validate HTML
    runs-on: ubuntu-latest
    needs: [build]

    steps:
      - name: Download built site
        uses: actions/download-artifact@v4
        with:
          name: jekyll-site
          path: _site/

      - name: Validate HTML
        uses: Cyb3r-Jak3/html5validator-action@v7.2.0
        with:
          root: _site/
          css: true

      - name: Check for common issues
        run: |
          echo "Checking for common HTML issues in built site..."

          # Check for missing alt attributes on images
          if find _site -name "*.html" -exec grep -l '<img[^>]*>' {} \; | xargs grep -h '<img[^>]*>' | grep -v 'alt=' ; then
            echo "Warning: Found img tags without alt attributes"
          fi

          echo "Basic validation checks completed!"

  # Link checker job - runs on push, PR, and schedule
  link-check:
    name: Check Links
    runs-on: ubuntu-latest
    needs: [build]
    if: github.event_name != 'pull_request'

    steps:
      - name: Download built site
        uses: actions/download-artifact@v4
        with:
          name: jekyll-site
          path: _site/

      - name: Check internal links
        run: |
          echo "Checking internal anchor links in built site..."

          # Check index.html for broken internal links
          if [ -f "_site/index.html" ]; then
            # Extract all href="#..." links
            grep -o 'href="#[^"]*"' _site/index.html | sed 's/href="#\([^"]*\)"/\1/' > links.txt || true

            # Extract all id="..." attributes
            grep -o 'id="[^"]*"' _site/index.html | sed 's/id="\([^"]*\)"/\1/' > ids.txt || true

            # Check if all internal links have corresponding IDs
            if [ -s links.txt ]; then
              while read link; do
                if ! grep -q "^$link$" ids.txt; then
                  echo "WARNING: Potential broken internal link: #$link"
                fi
              done < links.txt
            fi
          fi

          echo "Link check completed!"

  # Deploy and purge cache - only runs on push to master
  deploy:
    name: Deploy & Purge Cache
    runs-on: ubuntu-latest
    needs: [validate, link-check]
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'

    # Grant GITHUB_TOKEN the permissions required to make a Pages deployment
    permissions:
      pages: write
      id-token: write
      contents: read

    # Deploy to the github-pages environment
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Download built site
        uses: actions/download-artifact@v4
        with:
          name: jekyll-site
          path: _site/

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site/

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Wait for deployment to propagate
        run: |
          echo "Waiting 15 seconds for deployment to propagate..."
          sleep 15

      - name: Purge Cloudflare cache
        run: |
          echo "Purging Cloudflare cache for jpautomotivegroup.com..."

          RESPONSE=$(curl -X POST "https://api.cloudflare.com/client/v4/zones/${{ secrets.CLOUDFLARE_ZONE_ID }}/purge_cache" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            --data '{"purge_everything":true}' \
            -w "\n%{http_code}" -s)

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "Response: $BODY"

          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "âœ… Cloudflare cache purged successfully!"
          else
            echo "âŒ Failed to purge Cloudflare cache (HTTP $HTTP_CODE)"
            echo "$BODY"
            exit 1
          fi

      - name: Deployment summary
        run: |
          echo "ðŸš€ Deployment completed successfully!"
          echo "ðŸ“¦ Site: https://jpautomotivegroup.com"
          echo "ðŸ”„ Cloudflare cache purged"
          echo "â° Deployed at: $(date)"

  # Performance audit - runs on push to master
  lighthouse:
    name: Lighthouse Audit
    runs-on: ubuntu-latest
    needs: [deploy]
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'

    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Wait for deployment and cache purge to propagate
        run: sleep 20

      - name: Run Lighthouse
        uses: treosh/lighthouse-ci-action@v12
        with:
          urls: |
            https://jpautomotivegroup.com
          uploadArtifacts: false
          temporaryPublicStorage: false
          runs: 3

      - name: Display Lighthouse scores
        run: |
          echo "ðŸ“Š Lighthouse Audit Results for jpautomotivegroup.com"
          echo "=================================================="

          if [ -d ".lighthouseci" ]; then
            # Find the most recent JSON report
            REPORT=$(ls -t .lighthouseci/lhr-*.json | head -n 1)

            if [ -f "$REPORT" ]; then
              echo ""
              echo "ðŸŽ¯ Performance Scores (0-100):"
              echo "----------------------------------------"

              # Extract scores using jq (pre-installed on GitHub runners)
              PERFORMANCE=$(jq -r '.categories.performance.score * 100 | floor' "$REPORT")
              ACCESSIBILITY=$(jq -r '.categories.accessibility.score * 100 | floor' "$REPORT")
              BEST_PRACTICES=$(jq -r '.categories["best-practices"].score * 100 | floor' "$REPORT")
              SEO=$(jq -r '.categories.seo.score * 100 | floor' "$REPORT")

              echo "âš¡ Performance:     $PERFORMANCE/100"
              echo "â™¿ Accessibility:   $ACCESSIBILITY/100"
              echo "âœ… Best Practices:  $BEST_PRACTICES/100"
              echo "ðŸ” SEO:             $SEO/100"
              echo ""
              echo "ðŸ“ Full reports available in artifacts"
            else
              echo "âš ï¸ No JSON report found"
            fi
          else
            echo "âš ï¸ No Lighthouse results directory found"
          fi

      - name: Upload Lighthouse results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-results
          path: .lighthouseci/
          if-no-files-found: warn
