---
layout: default
---

<div class="bg-white">
  <!-- Breadcrumb -->
  <div class="bg-gray-100 py-4">
    <div class="container mx-auto px-4">
      <nav class="text-sm">
        <a href="/" class="text-gray-600 hover:text-primary">Home</a>
        <span class="mx-2 text-gray-400">/</span>
        <a href="/inventory" class="text-gray-600 hover:text-primary">Inventory</a>
        <span class="mx-2 text-gray-400">/</span>
        <span class="text-gray-900">{{ page.year }} {{ page.make }} {{ page.model }}</span>
      </nav>
    </div>
  </div>

  <!-- Vehicle Details -->
  <div class="container mx-auto px-4 py-8">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Main Content - Left Column -->
      <div class="lg:col-span-2">
        <!-- Vehicle Title -->
        <div class="mb-6">
          <h1 class="text-4xl font-bold text-gray-900 mb-2">{{ page.year }} {{ page.make }} {{ page.model }}</h1>
          {% if page.trim %}
            <p class="text-xl text-gray-600">{{ page.trim }}</p>
          {% endif %}
        </div>

        <!-- Image Gallery -->
        <div class="mb-8">
          <!-- Main Display Image -->
          <div id="gallery-container" class="bg-gray-200 rounded-lg overflow-hidden mb-3 relative" style="touch-action: pan-y; user-select: none;">
            {% if page.primary_image and page.primary_image != "" %}
            <img id="main-image" src="{{ page.primary_image }}" alt="{{ page.title }}" class="w-full aspect-[4/3] object-contain bg-gray-100 cursor-pointer" onclick="openLightbox(currentIndex)">
            {% else %}
            <div class="w-full aspect-[4/3] flex items-center justify-center bg-gray-200">
              <span class="text-gray-400 text-6xl">üöó</span>
            </div>
            {% endif %}

            {% if page.images.size > 1 %}
            <!-- Prev Arrow -->
            <button onclick="previousImage()" style="touch-action: manipulation;" class="gallery-arrow absolute left-2 top-1/2 -translate-y-1/2 bg-black/40 hover:bg-black/70 text-white p-2 md:p-3 rounded-full transition-opacity duration-200 opacity-100 md:opacity-0 md:group-hover:opacity-100 focus:outline-none">
              <svg class="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 19l-7-7 7-7"></path>
              </svg>
            </button>
            <!-- Next Arrow -->
            <button onclick="nextImage()" style="touch-action: manipulation;" class="gallery-arrow absolute right-2 top-1/2 -translate-y-1/2 bg-black/40 hover:bg-black/70 text-white p-2 md:p-3 rounded-full transition-opacity duration-200 opacity-100 md:opacity-0 md:group-hover:opacity-100 focus:outline-none">
              <svg class="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 5l7 7-7 7"></path>
              </svg>
            </button>

            <!-- Image Counter -->
            <div class="absolute bottom-3 right-3 bg-black/50 text-white px-3 py-1 rounded-full text-sm font-medium pointer-events-none">
              <span id="current-image-num">1</span> / {{ page.images.size }}
            </div>
            {% endif %}
          </div>

          <!-- Carousel Strip (replaces thumbnail grid) -->
          {% if page.images.size > 1 %}
          <div id="carousel-strip" class="flex gap-2 overflow-x-auto pb-1" style="scrollbar-width: none; -ms-overflow-style: none;">
            {% for image in page.images %}
            {% if image and image != "" %}
            <div class="carousel-thumb flex-shrink-0 rounded overflow-hidden cursor-pointer border-2 transition-all duration-150 {% if forloop.first %}border-primary{% else %}border-transparent{% endif %}" style="width: 64px; height: 56px; touch-action: manipulation;" onclick="changeImage({{ forloop.index0 }})">
              <img src="{{ image }}" alt="{{ page.title }} photo {{ forloop.index }}" class="w-full h-full object-cover" loading="lazy">
            </div>
            {% endif %}
            {% endfor %}
          </div>
          <style>#carousel-strip::-webkit-scrollbar { display: none; }</style>
          {% endif %}
        </div>

        <!-- Lightbox Modal -->
        <div id="lightbox" class="fixed inset-0 bg-black/95 z-50 hidden flex-col items-center justify-center" style="display: none;">
          <!-- Close -->
          <button onclick="closeLightbox()" style="touch-action: manipulation;" class="absolute top-4 right-4 text-white hover:text-gray-300 transition z-10 focus:outline-none">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>

          <!-- Prev Arrow -->
          <button onclick="previousImage()" style="touch-action: manipulation;" class="absolute left-3 top-1/2 -translate-y-1/2 bg-white/40 hover:bg-white/60 text-white p-3 rounded-full transition focus:outline-none z-10">
            <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 19l-7-7 7-7"></path>
            </svg>
          </button>

          <!-- Main Lightbox Image -->
          <div id="lightbox-image-wrap" class="flex items-center justify-center w-full" style="height: calc(100vh - 120px); touch-action: pan-y; user-select: none;">
            {% if page.primary_image and page.primary_image != "" %}
            <img id="lightbox-image" src="{{ page.primary_image }}" alt="{{ page.title }}" class="max-h-full max-w-full object-contain">
            {% else %}
            <span class="text-gray-400 text-9xl">üöó</span>
            {% endif %}
          </div>

          <!-- Next Arrow -->
          <button onclick="nextImage()" style="touch-action: manipulation;" class="absolute right-3 top-1/2 -translate-y-1/2 bg-white/40 hover:bg-white/60 text-white p-3 rounded-full transition focus:outline-none z-10">
            <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 5l7 7-7 7"></path>
            </svg>
          </button>

          <!-- Counter -->
          <div class="absolute top-4 left-1/2 -translate-x-1/2 bg-black/50 text-white px-3 py-1 rounded-full text-sm font-medium pointer-events-none">
            <span id="lightbox-counter">1</span> / {{ page.images.size }}
          </div>

          <!-- Lightbox Carousel Strip -->
          {% if page.images.size > 1 %}
          <div class="absolute bottom-0 left-0 right-0 bg-black/60 py-2 px-3">
            <div id="lightbox-strip" class="flex gap-2 overflow-x-auto" style="scrollbar-width: none; -ms-overflow-style: none;">
              {% for image in page.images %}
              {% if image and image != "" %}
              <div class="lightbox-thumb flex-shrink-0 rounded overflow-hidden cursor-pointer border-2 transition-all duration-150 {% if forloop.first %}border-primary{% else %}border-transparent opacity-60{% endif %}" style="width: 56px; height: 48px; touch-action: manipulation;" onclick="changeImage({{ forloop.index0 }})">
                <img src="{{ image }}" alt="{{ page.title }} photo {{ forloop.index }}" class="w-full h-full object-cover" loading="lazy">
              </div>
              {% endif %}
              {% endfor %}
            </div>
          </div>
          <style>#lightbox-strip::-webkit-scrollbar { display: none; }</style>
          {% endif %}
        </div>

        <script>
          const images = {{ page.images | jsonify }};
          let currentIndex = 0;

          function changeImage(index) {
            currentIndex = index;
            const mainImg = document.getElementById('main-image');
            const lbImg  = document.getElementById('lightbox-image');
            if (mainImg) mainImg.src = images[index];
            if (lbImg)   lbImg.src  = images[index];
            document.getElementById('current-image-num').textContent = index + 1;
            document.getElementById('lightbox-counter').textContent  = index + 1;

            // Update carousel strip highlights
            document.querySelectorAll('.carousel-thumb').forEach((t, i) => {
              t.classList.toggle('border-primary', i === index);
              t.classList.toggle('border-transparent', i !== index);
            });
            // Update lightbox strip highlights
            document.querySelectorAll('.lightbox-thumb').forEach((t, i) => {
              t.classList.toggle('border-primary', i === index);
              t.classList.toggle('border-transparent', i !== index);
              t.classList.toggle('opacity-60', i !== index);
            });

            // Scroll both strips to keep active thumb centered
            scrollStripToIndex('carousel-strip',  '.carousel-thumb',  index);
            scrollStripToIndex('lightbox-strip',  '.lightbox-thumb',  index);
          }

          function scrollStripToIndex(stripId, thumbSelector, index) {
            const strip = document.getElementById(stripId);
            if (!strip) return;
            const thumbs = strip.querySelectorAll(thumbSelector);
            if (!thumbs[index]) return;
            const thumb = thumbs[index];
            const stripRect = strip.getBoundingClientRect();
            const thumbRect = thumb.getBoundingClientRect();
            const offset = thumb.offsetLeft - strip.offsetLeft - (strip.clientWidth / 2) + (thumb.clientWidth / 2);
            strip.scrollTo({ left: offset, behavior: 'smooth' });
          }

          function nextImage() {
            currentIndex = (currentIndex + 1) % images.length;
            changeImage(currentIndex);
          }

          function previousImage() {
            currentIndex = (currentIndex - 1 + images.length) % images.length;
            changeImage(currentIndex);
          }

          function openLightbox(index) {
            currentIndex = index;
            changeImage(index);
            const lb = document.getElementById('lightbox');
            lb.style.display = 'flex';
            lb.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
          }

          function closeLightbox() {
            const lb = document.getElementById('lightbox');
            lb.style.display = 'none';
            lb.classList.add('hidden');
            document.body.style.overflow = '';
          }

          // Keyboard navigation
          document.addEventListener('keydown', (e) => {
            if (document.getElementById('lightbox').style.display === 'none') return;
            if (e.key === 'ArrowLeft')  previousImage();
            if (e.key === 'ArrowRight') nextImage();
            if (e.key === 'Escape')     closeLightbox();
          });

          // Close lightbox on backdrop click
          document.getElementById('lightbox').addEventListener('click', (e) => {
            if (e.target === document.getElementById('lightbox') ||
                e.target === document.getElementById('lightbox-image-wrap')) {
              closeLightbox();
            }
          });

          // ‚îÄ‚îÄ Swipe support ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          function addSwipe(elementId, onSwipeLeft, onSwipeRight) {
            const el = document.getElementById(elementId);
            if (!el) return;
            let startX = 0, startY = 0, isDragging = false;

            el.addEventListener('touchstart', (e) => {
              startX = e.touches[0].clientX;
              startY = e.touches[0].clientY;
              isDragging = true;
            }, { passive: true });

            el.addEventListener('touchend', (e) => {
              if (!isDragging) return;
              isDragging = false;
              const dx = e.changedTouches[0].clientX - startX;
              const dy = e.changedTouches[0].clientY - startY;
              // Only register horizontal swipe if mostly horizontal
              if (Math.abs(dx) > 50 && Math.abs(dx) > Math.abs(dy) * 1.5) {
                if (dx < 0) onSwipeLeft();
                else        onSwipeRight();
              }
            }, { passive: true });

            el.addEventListener('touchcancel', () => { isDragging = false; });
          }

          addSwipe('gallery-container',    nextImage, previousImage);
          addSwipe('lightbox-image-wrap',  nextImage, previousImage);
        </script>

        <!-- Vehicle Description -->
        <div class="mb-8">
          <h2 class="text-2xl font-bold text-gray-900 mb-4">Description</h2>
          <div class="prose max-w-none text-gray-700">
            {{ content }}
          </div>
        </div>

        <!-- Key Specifications -->
        <div class="mb-8">
          <h2 class="text-2xl font-bold text-gray-900 mb-4">Key Specifications</h2>
          <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
            <div class="bg-gray-50 p-4 rounded-lg">
              <p class="text-sm text-gray-600">Mileage</p>
              <p class="text-lg font-semibold text-gray-900">{{ page.mileage | number_with_delimiter }} miles</p>
            </div>
            <div class="bg-gray-50 p-4 rounded-lg">
              <p class="text-sm text-gray-600">Transmission</p>
              <p class="text-lg font-semibold text-gray-900">{{ page.transmission }}</p>
            </div>
            <div class="bg-gray-50 p-4 rounded-lg">
              <p class="text-sm text-gray-600">Drivetrain</p>
              <p class="text-lg font-semibold text-gray-900">{{ page.drivetrain }}</p>
            </div>
            <div class="bg-gray-50 p-4 rounded-lg">
              <p class="text-sm text-gray-600">Engine</p>
              <p class="text-lg font-semibold text-gray-900">{{ page.engine }}</p>
            </div>
            <div class="bg-gray-50 p-4 rounded-lg">
              <p class="text-sm text-gray-600">Fuel Type</p>
              <p class="text-lg font-semibold text-gray-900">{{ page.fuel_type }}</p>
            </div>
            <div class="bg-gray-50 p-4 rounded-lg">
              <p class="text-sm text-gray-600">MPG</p>
              <p class="text-lg font-semibold text-gray-900">City: {{ page.mpg_city }} / Highway: {{ page.mpg_highway }}</p>
            </div>
          </div>
        </div>

        <!-- Features -->
        {% if page.features %}
        <div class="mb-8">
          <h2 class="text-2xl font-bold text-gray-900 mb-4">Features & Options</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            {% for feature in page.features %}
            <div class="flex items-center gap-2">
              <svg class="w-5 h-5 text-green-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
              </svg>
              <span class="text-gray-700">{{ feature }}</span>
            </div>
            {% endfor %}
          </div>
        </div>
        {% endif %}

        <!-- Vehicle History -->
        <div class="mb-8">
          <h2 class="text-2xl font-bold text-gray-900 mb-4">Vehicle History</h2>
          <div class="bg-gray-50 p-6 rounded-lg space-y-3">
            <div class="flex justify-between">
              <span class="text-gray-600">VIN:</span>
              <span class="font-semibold text-gray-900">{{ page.vin }}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">Previous Owners:</span>
              <span class="font-semibold text-gray-900">{{ page.previous_owners }}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">Accident History:</span>
              <span class="font-semibold text-gray-900">{{ page.accident_history }}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">Service Records on File:</span>
              <span class="font-semibold text-gray-900">{{ page.service_records_on_file }}</span>
            </div>
            {% if page.carfax_available %}
            <div class="pt-4 border-t border-gray-200">
              <a href="#" class="inline-flex items-center gap-2 text-primary hover:text-primary-dark font-semibold">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                View Full Carfax Report
              </a>
            </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Sidebar - Right Column -->
      <div class="lg:col-span-1">
        <!-- Price Card -->
        <div class="bg-white border-2 border-gray-200 rounded-lg p-6 mb-6 sticky top-24">
          <div class="text-center mb-6">
            <p class="text-sm text-gray-600 mb-2">Our Price</p>
            <p class="text-4xl font-bold text-primary">${{ page.price | divided_by: 1.0 | round | number_with_delimiter }}</p>
            {% if page.warranty %}
            <p class="text-sm text-green-600 mt-2">‚úì {{ page.warranty }}</p>
            {% endif %}
          </div>

          <!-- Contact Buttons -->
          <div class="space-y-3">
            <!-- Desktop: Show phone number -->
            <div class="hidden md:block w-full bg-primary text-white text-center py-3 rounded-lg font-semibold">
              üìû (916) 618-7197
            </div>
            <!-- Mobile: Click-to-call -->
            <a href="tel:+19166187197" class="block md:hidden w-full bg-primary text-white text-center py-3 rounded-lg hover:bg-primary-dark transition font-semibold">
              üìû Call Now
            </a>
            <a href="{{ site.business.maps_link }}" target="_blank" rel="noopener" class="block w-full border-2 border-primary text-primary text-center py-3 rounded-lg hover:bg-primary hover:text-white transition font-semibold">
              üìç Get Directions
            </a>
          </div>

          <!-- OTD Price Button -->
          <div class="mt-4">
            <button onclick="openOTD()" style="touch-action: manipulation;" class="block w-full bg-gray-900 text-white text-center py-3 rounded-lg hover:bg-gray-700 transition font-semibold text-sm">
              üßæ What's my Out-the-Door Price?
            </button>
          </div>

          <!-- Payment Estimator -->
          <div class="mt-6 pt-6 border-t border-gray-200">
            <p class="text-sm text-gray-600 mb-1">Estimated Monthly Payment</p>
            <p class="text-2xl font-bold text-gray-900 mb-1">$<span id="monthly-payment"></span>/mo</p>
            <p class="text-xs text-gray-500 mb-1">Est. ~$<span id="down-payment-display"></span> down ¬∑ 14% APR ¬∑ 60 mo ¬∑ 650+ credit score</p>
            <p class="text-xs text-gray-400">Subject to credit approval. Actual terms may vary.</p>
            <a href="/financing?vehicle={{ page.title | url_encode }}" class="block mt-4 text-center text-primary hover:text-primary-dark font-semibold text-sm">
              Get Pre-Approved ‚Üí
            </a>
          </div>

          <script>
            (function() {
              const price = {{ page.price }};
              // Down payment: 20% of price rounded up to nearest $100
              const downPayment = Math.ceil((price * 0.20) / 100) * 100;
              const principal = price - downPayment;
              const monthlyRate = 0.14 / 12;
              const n = 60;
              const calculated = principal * (monthlyRate * Math.pow(1 + monthlyRate, n)) / (Math.pow(1 + monthlyRate, n) - 1);
              const monthly = Math.max(250, Math.round(calculated));

              document.getElementById('monthly-payment').textContent = monthly.toLocaleString();
              document.getElementById('down-payment-display').textContent = downPayment.toLocaleString();
            })();
          </script>
        </div>
      </div>
    </div>

    <!-- OTD Price Modal -->
    <div id="otd-modal" class="fixed inset-0 bg-black/60 z-50 items-center justify-center p-4" style="display: none;">
      <div class="bg-white rounded-xl shadow-2xl w-full max-w-md max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
        <!-- Header -->
        <div class="flex items-center justify-between p-5 border-b border-gray-200">
          <div>
            <h2 class="text-xl font-bold text-gray-900">Out-the-Door Price</h2>
            <p class="text-sm text-gray-500 mt-0.5">{{ page.year }} {{ page.make }} {{ page.model }}</p>
          </div>
          <button onclick="closeOTD()" style="touch-action: manipulation;" class="text-gray-400 hover:text-gray-600 transition focus:outline-none">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>

        <!-- ZIP Input -->
        <div class="p-5 border-b border-gray-100">
          <label class="block text-sm font-medium text-gray-700 mb-2">Your ZIP Code</label>
          <div class="flex gap-2">
            <input id="otd-zip" type="text" inputmode="numeric" pattern="[0-9]*" maxlength="5" placeholder="e.g. 95815" style="font-size: 16px;" class="flex-1 border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" oninput="this.value=this.value.replace(/[^0-9]/g,''); if(this.value.length===5) calcOTD();">
            <button onclick="calcOTD()" style="touch-action: manipulation;" class="bg-primary text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-primary-dark transition">
              Calculate
            </button>
          </div>
          <p id="otd-zip-note" class="text-xs text-gray-400 mt-1.5">Enter your CA ZIP code for an accurate estimate.</p>
        </div>

        <!-- Fee Breakdown -->
        <div id="otd-breakdown" class="p-5 space-y-2.5 hidden">
          <!-- Vehicle Price -->
          <div class="flex justify-between items-center">
            <span class="text-sm text-gray-700">Vehicle Price</span>
            <span class="text-sm font-semibold text-gray-900" id="otd-vehicle-price"></span>
          </div>
          <!-- Doc Fee -->
          <div class="flex justify-between items-center">
            <span class="text-sm text-gray-700">Document Processing Fee</span>
            <span class="text-sm font-semibold text-gray-900">$70.00</span>
          </div>
          <!-- E-Filing -->
          <div class="flex justify-between items-center">
            <span class="text-sm text-gray-700">Electronic Filing Fee</span>
            <span class="text-sm font-semibold text-gray-900">$33.00</span>
          </div>
          <!-- Emission Testing (CA non-EV only) -->
          <div id="otd-row-emission" class="flex justify-between items-center hidden">
            <span class="text-sm text-gray-700">Emission Testing Fee</span>
            <span class="text-sm font-semibold text-gray-900">$50.00</span>
          </div>
          <!-- Smog Cert (CA non-EV only) -->
          <div id="otd-row-smog" class="flex justify-between items-center hidden">
            <span class="text-sm text-gray-700">Smog Certification Fee</span>
            <span class="text-sm font-semibold text-gray-900">$8.25</span>
          </div>
          <!-- Sales Tax -->
          <div id="otd-row-tax" class="flex justify-between items-center hidden">
            <div>
              <span class="text-sm text-gray-700">Sales Tax</span>
              <span id="otd-tax-rate-label" class="text-xs text-gray-400 ml-1"></span>
            </div>
            <span class="text-sm font-semibold text-gray-900" id="otd-tax-amount"></span>
          </div>
          <!-- License Fee -->
          <div id="otd-row-license" class="flex justify-between items-center hidden">
            <div>
              <span class="text-sm text-gray-700">License Fee</span>
              <span class="text-xs text-amber-600 ml-1 font-medium">ESTIMATE</span>
            </div>
            <span class="text-sm font-semibold text-gray-900">$135.00</span>
          </div>
          <!-- DMV Registration -->
          <div id="otd-row-dmv" class="flex justify-between items-center hidden">
            <div>
              <span class="text-sm text-gray-700">DMV Registration</span>
              <span class="text-xs text-amber-600 ml-1 font-medium">ESTIMATE</span>
            </div>
            <span class="text-sm font-semibold text-gray-900">$351.00</span>
          </div>

          <!-- Divider -->
          <div class="border-t border-gray-200 pt-2.5 mt-2.5">
            <div class="flex justify-between items-center">
              <span class="font-bold text-gray-900">Estimated OTD Total</span>
              <span class="text-xl font-bold text-primary" id="otd-total"></span>
            </div>
          </div>

          <!-- Out-of-state note -->
          <div id="otd-oos-note" class="hidden mt-3 p-3 bg-amber-50 border border-amber-200 rounded-lg text-xs text-amber-800 leading-relaxed">
            <p class="font-semibold mb-1">Out-of-State Purchase Notice</p>
            <p>For out-of-state purchases you're required to process registration yourself at your home state DMV. Please check with your local DMV for a list of requirements to register an out-of-state vehicle. Additionally, out-of-state purchasers can <strong>only ship the vehicle</strong> ‚Äî in-person pickup is not available.</p>
          </div>

          <!-- Disclaimer -->
          <p id="otd-disclaimer" class="text-xs text-gray-400 pt-1 leading-relaxed hidden">
            This estimate is for informational purposes only. License and registration fees are estimates based on standard CA rates. Final amounts determined at time of sale. Sales tax calculated on vehicle price, doc fee, and electronic filing fee per CA CDTFA guidelines.
          </p>
        </div>
      </div>
    </div>

    <script src="/assets/js/ca-tax-rates.js"></script>
    <script>
    // ‚îÄ‚îÄ OTD Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const OTD_VEHICLE_PRICE = {{ page.price }};
    const OTD_FUEL_TYPE = {{ page.fuel_type | jsonify }};
    const OTD_YEAR = {{ page.year }};

    // CA_TAX_RATES is loaded from /assets/js/ca-tax-rates.js (external file, browser-cached)

    // CA ZIP prefix ranges (first 3 digits) for detecting CA ZIPs
    // CA ZIPs start with 900‚Äì961
    function isCaliforniaZip(zip) {
      if (!/^\d{5}$/.test(zip)) return false;
      const prefix = parseInt(zip.substring(0, 3));
      return prefix >= 900 && prefix <= 961;
    }

    function isElectric() {
      const ft = (OTD_FUEL_TYPE || '').toLowerCase();
      return ft.includes('electric') || ft.includes('ev') || ft === 'bev' || ft === 'phev';
    }

    function fmt(n) {
      return '$' + n.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }

    function openOTD() {
      const modal = document.getElementById('otd-modal');
      modal.style.removeProperty('display');
      modal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
      document.getElementById('otd-zip').focus();
    }

    function closeOTD() {
      document.getElementById('otd-modal').style.display = 'none';
      document.body.style.overflow = '';
    }

    // Close on backdrop click
    document.getElementById('otd-modal').addEventListener('click', function(e) {
      if (e.target === this) closeOTD();
    });

    function calcOTD() {
      const zip = document.getElementById('otd-zip').value.trim();
      if (zip.length !== 5) return;

      const caZip  = isCaliforniaZip(zip);
      const ev     = isElectric();
      const docFee = 70;
      const eFiling = 33;

      // Show breakdown panel
      const bd = document.getElementById('otd-breakdown');
      bd.classList.remove('hidden');

      // Vehicle price row
      document.getElementById('otd-vehicle-price').textContent = fmt(OTD_VEHICLE_PRICE);

      // Emission / smog rows
      const showEmission = caZip && !ev;
      document.getElementById('otd-row-emission').classList.toggle('hidden', !showEmission);
      document.getElementById('otd-row-smog').classList.toggle('hidden', !showEmission);

      // CA-only rows
      document.getElementById('otd-row-license').classList.toggle('hidden', !caZip);
      document.getElementById('otd-row-dmv').classList.toggle('hidden', !caZip);

      // OOS note
      document.getElementById('otd-oos-note').classList.toggle('hidden', caZip);
      document.getElementById('otd-disclaimer').classList.toggle('hidden', !caZip);

      // ZIP note
      const zipNote = document.getElementById('otd-zip-note');

      let taxAmount = 0;
      if (caZip) {
        const rate = CA_TAX_RATES[zip] || 0.0725; // default to state minimum if ZIP not in table
        const taxLabel = (rate * 100).toFixed(3).replace(/\.?0+$/, '') + '%';
        const taxBase  = OTD_VEHICLE_PRICE + docFee + eFiling;
        taxAmount = taxBase * rate;
        document.getElementById('otd-tax-rate-label').textContent = '(' + taxLabel + ')';
        document.getElementById('otd-tax-amount').textContent = fmt(taxAmount);
        document.getElementById('otd-row-tax').classList.remove('hidden');
        if (!CA_TAX_RATES[zip]) {
          zipNote.textContent = 'ZIP ' + zip + ' not found ‚Äî using CA state minimum rate (7.25%). Verify your local rate at cdtfa.ca.gov.';
          zipNote.className = 'text-xs text-amber-600 mt-1.5';
        } else {
          zipNote.textContent = 'Rate for ' + zip + ': ' + taxLabel;
          zipNote.className = 'text-xs text-gray-400 mt-1.5';
        }
      } else {
        document.getElementById('otd-row-tax').classList.add('hidden');
        zipNote.textContent = 'Out-of-state ZIP detected ‚Äî DMV and tax fees set to $0.';
        zipNote.className = 'text-xs text-amber-600 mt-1.5';
      }

      // Calculate total
      let total = OTD_VEHICLE_PRICE + docFee + eFiling;
      if (showEmission) total += 50 + 8.25;
      if (caZip) {
        total += taxAmount + 135 + 351;
      }

      document.getElementById('otd-total').textContent = fmt(total);
    }
    </script>

    <!-- Similar Vehicles -->
    <div class="mt-12">
      <h2 class="text-3xl font-bold text-gray-900 mb-6">Similar Vehicles</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        {% assign similar = site.vehicles | where_exp: "vehicle", "vehicle.make == page.make" | where_exp: "vehicle", "vehicle.url != page.url" | limit: 3 %}
        {% for vehicle in similar %}
        <a href="{{ vehicle.url }}" class="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-xl transition">
          {% if vehicle.primary_image and vehicle.primary_image != "" %}
          <img src="{{ vehicle.primary_image }}" alt="{{ vehicle.title }}" class="w-full h-48 object-cover">
          {% else %}
          <div class="w-full h-48 flex items-center justify-center bg-gray-200">
            <span class="text-gray-400 text-4xl">üöó</span>
          </div>
          {% endif %}
          <div class="p-4">
            <h3 class="font-bold text-lg text-gray-900">{{ vehicle.year }} {{ vehicle.make }} {{ vehicle.model }}</h3>
            <p class="text-2xl font-bold text-primary mt-2">${{ vehicle.price | divided_by: 1.0 | round | number_with_delimiter }}</p>
            <p class="text-sm text-gray-600 mt-1">{{ vehicle.mileage | divided_by: 1000 }}K miles ‚Ä¢ {{ vehicle.transmission }}</p>
          </div>
        </a>
        {% endfor %}
      </div>
    </div>
  </div>
</div>
